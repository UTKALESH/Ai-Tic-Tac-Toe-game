<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tic Tac Toe</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <div class="container">
        <h1 class="title">Tic Tac Toe</h1>
        <div id="board" class="board">
            {% for i in range(9) %}
            <div class="cell" id="cell-{{ i }}" onclick="makeMove({{ i }})"></div>
            {% endfor %}
            <div id="winning-line" class="winning-line"></div>
        </div>
        <button onclick="resetGame()" class="reset-btn">Reset Game</button>
        <p id="status" class="status"></p>
    </div>
    <script>
        let board = ["", "", "", "", "", "", "", "", ""];

    async function makeMove(position) {
        if (board[position] !== "") return; // Prevent invalid moves
        const response = await fetch('/move', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ position })
        });
        const data = await response.json();
        board = data.board;
        renderBoard(data.combo);
        document.getElementById('status').textContent =
            data.status === 'win' ? `${data.winner} wins!` :
            data.status === 'draw' ? "It's a draw!" : '';
    }

    function renderBoard(combo) {
        board.forEach((value, i) => {
            const cell = document.getElementById(`cell-${i}`);
            cell.textContent = value;
            cell.className = `cell ${value}`;
        });
        if (combo) drawWinningLine(combo);
    }

    function drawWinningLine(combo) {
        const boardElement = document.getElementById("board");
        const line = document.getElementById("winning-line");
        const [start, , end] = combo;
        const startCell = document.getElementById(`cell-${start}`);
        const endCell = document.getElementById(`cell-${end}`);
        const boardRect = boardElement.getBoundingClientRect();
        const startRect = startCell.getBoundingClientRect();
        const endRect = endCell.getBoundingClientRect();

        // Calculate the line's start and end positions relative to the board
        const startX = startRect.left + startRect.width / 2 - boardRect.left;
        const startY = startRect.top + startRect.height / 2 - boardRect.top;
        const endX = endRect.left + endRect.width / 2 - boardRect.left;
        const endY = endRect.top + endRect.height / 2 - boardRect.top;

        // Calculate the line's rotation and length
        const length = Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2));
        const angle = Math.atan2(endY - startY, endX - startX) * (180 / Math.PI);

        // Position and style the line
        line.style.width = `${length}px`;
        line.style.transform = `translate(${startX}px, ${startY}px) rotate(${angle}deg)`;
        line.style.visibility = "visible";
    }

    async function resetGame() {
        const response = await fetch('/reset', { method: 'POST' });
        const data = await response.json();
        if (data.status === 'reset') {
            board = data.board;
            renderBoard();
            document.getElementById('winning-line').style.visibility = "hidden";
            document.getElementById('status').textContent = '';
        }
    }
    </script>
</body>
</html>